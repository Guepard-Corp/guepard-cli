name: Homebrew Core Formula

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to prepare/submit formula for (e.g., 0.26.19)'
        required: true
        type: string
      submit_pr:
        description: 'Actually submit PR to Homebrew Core (leave unchecked to just prepare)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  submit-to-homebrew-core:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config --global user.name "Ghassen MENAOUAR"
          git config --global user.email "ghassen.menaouar@guepard.run"

      - name: Download releases and calculate checksums
        run: |
          mkdir -p temp-releases
          cd temp-releases
          
          # Download all platform releases
          curl -L -o macos-arm64.tar.gz "https://github.com/Guepard-Corp/guepard-cli/releases/download/v${{ github.event.inputs.version }}/guepard-cli-v${{ github.event.inputs.version }}-macos-arm64.tar.gz"
          curl -L -o macos-amd64.tar.gz "https://github.com/Guepard-Corp/guepard-cli/releases/download/v${{ github.event.inputs.version }}/guepard-cli-v${{ github.event.inputs.version }}-macos-amd64.tar.gz"
          curl -L -o linux-arm64.tar.gz "https://github.com/Guepard-Corp/guepard-cli/releases/download/v${{ github.event.inputs.version }}/guepard-cli-v${{ github.event.inputs.version }}-linux-arm64.tar.gz"
          curl -L -o linux-amd64.tar.gz "https://github.com/Guepard-Corp/guepard-cli/releases/download/v${{ github.event.inputs.version }}/guepard-cli-v${{ github.event.inputs.version }}-linux-amd64.tar.gz"
          
          # Calculate checksums
          echo "MACOS_ARM64_SHA256=$(shasum -a 256 macos-arm64.tar.gz | cut -d' ' -f1)" >> $GITHUB_ENV
          echo "MACOS_AMD64_SHA256=$(shasum -a 256 macos-amd64.tar.gz | cut -d' ' -f1)" >> $GITHUB_ENV
          echo "LINUX_ARM64_SHA256=$(shasum -a 256 linux-arm64.tar.gz | cut -d' ' -f1)" >> $GITHUB_ENV
          echo "LINUX_AMD64_SHA256=$(shasum -a 256 linux-amd64.tar.gz | cut -d' ' -f1)" >> $GITHUB_ENV
          
          cd ..

      - name: Create Homebrew Core formula
        run: |
          VERSION="${{ github.event.inputs.version }}"
          mkdir -p Formula
          cat > Formula/guepard.rb << EOF
          class Guepard < Formula
            desc "Guepard CLI - Git for Data"
            homepage "https://www.guepard.run"
            url "https://github.com/Guepard-Corp/guepard-cli/releases/download/v\${VERSION}/guepard-cli-v\${VERSION}-macos-arm64.tar.gz"
            version "\${VERSION}"
            sha256 "${{ env.MACOS_ARM64_SHA256 }}"
            license "Guepard (c) 2025"

            on_macos do
              on_intel do
                url "https://github.com/Guepard-Corp/guepard-cli/releases/download/v\${VERSION}/guepard-cli-v\${VERSION}-macos-amd64.tar.gz"
                sha256 "${{ env.MACOS_AMD64_SHA256 }}"
              end
            end

            on_linux do
              on_arm do
                url "https://github.com/Guepard-Corp/guepard-cli/releases/download/v\${VERSION}/guepard-cli-v\${VERSION}-linux-arm64.tar.gz"
                sha256 "${{ env.LINUX_ARM64_SHA256 }}"
              end
              on_intel do
                url "https://github.com/Guepard-Corp/guepard-cli/releases/download/v\${VERSION}/guepard-cli-v\${VERSION}-linux-amd64.tar.gz"
                sha256 "${{ env.LINUX_AMD64_SHA256 }}"
              end
            end

            def install
              bin.install "guepard"
            end

            test do
              system "#{bin}/guepard", "--version"
            end
          end
          EOF

      - name: Create submission instructions
        run: |
          cat > HOMEBREW_CORE_SUBMISSION.md << EOF
          # Homebrew Core Submission for Guepard v${{ github.event.inputs.version }}

          ## Formula Details
          - **Name**: guepard
          - **Version**: ${{ github.event.inputs.version }}
          - **Description**: Guepard CLI - Git for Data
          - **Homepage**: https://www.guepard.run
          - **License**: Guepard (c) 2025

          ## Checksums
          - macOS ARM64: \`${{ env.MACOS_ARM64_SHA256 }}\`
          - macOS AMD64: \`${{ env.MACOS_AMD64_SHA256 }}\`
          - Linux ARM64: \`${{ env.LINUX_ARM64_SHA256 }}\`
          - Linux AMD64: \`${{ env.LINUX_AMD64_SHA256 }}\`

          ## Submission Steps

          1. **Fork homebrew-core**:
             \`\`\`bash
             # Go to https://github.com/Homebrew/homebrew-core and fork it
             git clone https://github.com/YOUR_USERNAME/homebrew-core.git
             cd homebrew-core
             \`\`\`

          2. **Copy the formula**:
             \`\`\`bash
             cp Formula/guepard.rb Formula/
             \`\`\`

          3. **Create branch and commit**:
             \`\`\`bash
             git checkout -b add-guepard-${{ github.event.inputs.version }}
             git add Formula/guepard.rb
             git commit -m "guepard ${{ github.event.inputs.version }} (new formula)"
             git push origin add-guepard-${{ github.event.inputs.version }}
             \`\`\`

          4. **Create Pull Request**:
             - Go to your fork on GitHub
             - Create PR against Homebrew/homebrew-core
             - Title: "guepard ${{ github.event.inputs.version }} (new formula)"
             - Use the description template below

          ## PR Description Template

          \`\`\`
          guepard ${{ github.event.inputs.version }} (new formula)

          Guepard CLI - Git for Data. Provides version control and management 
          capabilities for databases with familiar Git-like commands like init, 
          commit, branch, checkout, and more.

          Features:
          - Git-like interface with familiar commands
          - Multi-platform support (Linux, macOS, Windows)
          - Database management and deployment
          - Cross-platform consistency

          Homepage: https://www.guepard.run
          License: Guepard (c) 2025
          \`\`\`

          ## Files Ready for Submission
          - ✅ Formula: \`Formula/guepard.rb\`
          - ✅ Checksums: All calculated and verified
          - ✅ Instructions: This file

          Once the PR is merged, users can install with: \`brew install guepard\`
          EOF

      - name: Commit formula and instructions
        run: |
          git add Formula/guepard.rb HOMEBREW_CORE_SUBMISSION.md
          git commit -m "Prepare Homebrew Core formula for v${{ github.event.inputs.version }}"
          git push

      - name: Create direct submission instructions
        if: ${{ github.event.inputs.submit_pr == 'true' }}
        run: |
          cat > DIRECT_SUBMISSION.md << EOF
          # Direct Homebrew Core Submission for Guepard v${{ github.event.inputs.version }}

          ## 🚀 Quick Submission Steps

          ### 1. Fork homebrew-core
          Go to https://github.com/Homebrew/homebrew-core and click "Fork"

          ### 2. Clone your fork
          \`\`\`bash
          git clone https://github.com/YOUR_USERNAME/homebrew-core.git
          cd homebrew-core
          \`\`\`

          ### 3. Create branch
          \`\`\`bash
          git checkout -b add-guepard-${{ github.event.inputs.version }}
          \`\`\`

          ### 4. Copy the formula
          Copy the content from \`Formula/guepard.rb\` and create the file:
          \`\`\`bash
          # Create the file
          touch Formula/guepard.rb
          
          # Copy the content (the formula is ready in your repository)
          \`\`\`

          ### 5. Commit and push
          \`\`\`bash
          git add Formula/guepard.rb
          git commit -m "guepard ${{ github.event.inputs.version }} (new formula)"
          git push origin add-guepard-${{ github.event.inputs.version }}
          \`\`\`

          ### 6. Create Pull Request
          Go to your fork on GitHub and create a PR against Homebrew/homebrew-core

          ## 📋 Formula Content
          The formula is ready in: \`Formula/guepard.rb\`

          ## ✅ Checksums Verified
          - macOS ARM64: \`${{ env.MACOS_ARM64_SHA256 }}\`
          - macOS AMD64: \`${{ env.MACOS_AMD64_SHA256 }}\`
          - Linux ARM64: \`${{ env.LINUX_ARM64_SHA256 }}\`
          - Linux AMD64: \`${{ env.LINUX_AMD64_SHA256 }}\`

          ## 🎯 Result
          Once merged: \`brew install guepard\`
          EOF
          
          echo "📝 Created direct submission instructions: DIRECT_SUBMISSION.md"

      - name: Create summary
        run: |
          echo "## Homebrew Core Submission Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Formula:** \`Formula/guepard.rb\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checksums:" >> $GITHUB_STEP_SUMMARY
          echo "- macOS ARM64: \`${{ env.MACOS_ARM64_SHA256 }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- macOS AMD64: \`${{ env.MACOS_AMD64_SHA256 }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Linux ARM64: \`${{ env.LINUX_ARM64_SHA256 }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Linux AMD64: \`${{ env.LINUX_AMD64_SHA256 }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.submit_pr }}" = "true" ]; then
            echo "📋 **Direct submission instructions created**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To submit to Homebrew Core:" >> $GITHUB_STEP_SUMMARY
            echo "1. Follow \`DIRECT_SUBMISSION.md\` for step-by-step instructions" >> $GITHUB_STEP_SUMMARY
            echo "2. Fork [Homebrew/homebrew-core](https://github.com/Homebrew/homebrew-core)" >> $GITHUB_STEP_SUMMARY
            echo "3. Copy \`Formula/guepard.rb\` to your fork" >> $GITHUB_STEP_SUMMARY
            echo "4. Create a pull request" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Everything is ready in your repository!" >> $GITHUB_STEP_SUMMARY
          else
            echo "📋 **Formula prepared for manual submission**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To submit manually:" >> $GITHUB_STEP_SUMMARY
            echo "1. Follow instructions in \`HOMEBREW_CORE_SUBMISSION.md\`" >> $GITHUB_STEP_SUMMARY
            echo "2. Fork [Homebrew/homebrew-core](https://github.com/Homebrew/homebrew-core)" >> $GITHUB_STEP_SUMMARY
            echo "3. Copy \`Formula/guepard.rb\` to your fork" >> $GITHUB_STEP_SUMMARY
            echo "4. Create a pull request" >> $GITHUB_STEP_SUMMARY
          fi
